# Configure sentinel systemd service
---

- name: Deploy systemd service file
  ansible.builtin.template:
    src: sentinel.service.j2
    dest: /etc/systemd/system/{{ sentinel_service_name }}.service
    owner: root
    group: root
    mode: "0644"
  notify:
    - Reload systemd
    - Restart sentinel

- name: Enable sentinel service
  ansible.builtin.systemd:
    name: "{{ sentinel_service_name }}"
    enabled: true
    daemon_reload: true

- name: Start sentinel service
  ansible.builtin.systemd:
    name: "{{ sentinel_service_name }}"
    state: started
  register: sentinel_started

- name: Wait for sentinel to be ready
  ansible.builtin.uri:
    url: "http://127.0.0.1:{{ sentinel_port }}/actuator/health"
    method: GET
    return_content: true
    status_code: 200
  register: health_check
  until: health_check.status == 200
  retries: 30
  delay: 5
  when: sentinel_started.changed
