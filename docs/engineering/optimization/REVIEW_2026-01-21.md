# Optimization Changes Review

**Date:** 2026-01-21  
**Reviewed:** `docs/engineering/optimization/OPTIMIZATION_CHANGES.md`  
**Status:** Resolved in code as of 2026-01-22 (sector-aware cache keys applied)

---

## Summary

The optimization documentation is well-written and covers the changes comprehensively. Code verification originally revealed two critical security issues; both were remediated and re-tested.

---

## Critical Security Issues

### 1. QueryExpander Cache Missing Sector Isolation

**File:** `src/main/java/com/jreinhal/mercenary/rag/hybridrag/QueryExpander.java`

**Problem:** Cache keys use only `query|count` without tenant/sector prefix:
```java
String cacheKey = normalizedKey + "|" + count;
```

**Risk:** Query expansion patterns from one sector could be served to users in another sector. While this doesn't leak document content directly, it exposes which queries users are asking across security boundaries.

**Fix:** Change cache key to include sector:
```java
String cacheKey = sector + "|" + normalizedKey + "|" + count;
```

---

### 2. CrossEncoderReranker Cache Missing Sector Isolation

**File:** `src/main/java/com/jreinhal/mercenary/rag/hifirag/CrossEncoderReranker.java`

**Problem:** Cache keys use `query|source|hashCode` without tenant/sector:
```java
return query + "|" + sourceStr + "|" + content.hashCode();
```

**Risk:** Reranking scores computed for one sector's documents could influence retrieval ordering in another sector. This is a cross-tenant data leakage vector.

**Fix:** Include sector in cache key:
```java
return sector + "|" + query + "|" + sourceStr + "|" + content.hashCode();
```

---

## Documentation Gaps

### Missing Sections

| Gap | Description | Priority |
|-----|-------------|----------|
| **Monitoring** | No guidance on monitoring cache hit rates, thread pool utilization, or queue depth | High |
| **Cache Invalidation** | No mention of what happens when documents are updated/deleted | High |
| **Memory Impact** | No estimated memory footprint for different deployment sizes | Medium |
| **Performance Baseline** | No baseline comparison or expected improvements | Medium |

### Minor Issues

- Line 181: Gradle wrapper issue is operational troubleshooting, not optimization-related. Consider moving to a separate troubleshooting doc.

---

## Implementation Quality (Verified)

| Component | Status | Notes |
|-----------|--------|-------|
| Thread Pool Config | Good | Properly bounded, named, configurable with CallerRunsPolicy |
| Norm Caching | Good | Efficient vector similarity computation |
| Prefiltering | Good | Whitelist-based, reduces candidate set early |
| Query Expansion Cache | **Unsafe** | Missing sector isolation in cache keys |
| Reranker Cache | **Unsafe** | Missing sector isolation in cache keys |
| Error Handling | Good | InterruptedException properly preserved |
| Memory Leak Risk | Low | Bounded caches with TTL, proper cleanup |
| Configuration | Excellent | All parameters configurable, good defaults |

---

## Recommendations

| Priority | Action | Effort | Files |
|----------|--------|--------|-------|
| **Critical** | Add sector to QueryExpander cache keys | Low | `QueryExpander.java` |
| **Critical** | Add sector to CrossEncoderReranker cache keys | Low | `CrossEncoderReranker.java` |
| **High** | Add cache/thread pool metrics for monitoring | Medium | New config/metrics classes |
| **High** | Document cache invalidation strategy | Low | `docs/engineering/optimization/OPTIMIZATION_CHANGES.md` |
| **Medium** | Document memory footprint estimates | Low | `docs/engineering/optimization/OPTIMIZATION_CHANGES.md` |
| **Low** | Move Gradle issue to troubleshooting doc | Low | `docs/engineering/optimization/OPTIMIZATION_CHANGES.md` |

---

## Verified Safe Implementations

### Thread Interrupt Handling
Properly preserves interrupt state in parallel retrieval:
```java
catch (InterruptedException e) {
    Thread.currentThread().interrupt();  // Correct
    log.warn("...");
}
```

### Sector Isolation in Document Cache
The `secureDocCache` in MercenaryController correctly includes dept prefix:
```java
String cacheKey = dept + ":" + normalizedFileName;  // Safe
```

### Prefilter Security
LocalMongoVectorStore uses a whitelist of allowed filter fields:
```java
private static final Set<String> PREFILTER_KEYS = Set.of(
    "dept", "type", "partition_id", "source", "filename", "mimeType"
);
```

---

## Next Steps

1. Fix the two critical cache isolation issues before production deployment
2. Add monitoring for cache hit rates and thread pool metrics
3. Update documentation with cache invalidation guidance


