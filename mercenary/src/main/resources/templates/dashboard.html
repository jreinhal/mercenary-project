<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Mercenary AI | Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Highlight clickable citations */
        .citation-link {
            color: #34d399; /* Emerald 400 */
            text-decoration: underline;
            cursor: pointer;
            font-weight: bold;
        }
        .citation-link:hover {
            color: #10b981; /* Emerald 500 */
        }
    </style>
</head>
<body class="bg-slate-900 text-white font-sans antialiased h-screen flex flex-col relative">

<div id="sourceModal" class="fixed inset-0 bg-black/80 hidden z-50 flex items-center justify-center backdrop-blur-sm">
    <div class="bg-slate-800 w-3/4 h-3/4 rounded-lg border border-emerald-500/30 shadow-2xl flex flex-col overflow-hidden relative">
        <div class="bg-slate-900 p-4 border-b border-slate-700 flex justify-between items-center">
            <h3 class="text-emerald-500 font-mono tracking-wider text-sm">
                // DOCUMENT INSPECTOR // <span id="modalFileName" class="text-white">filename.pdf</span>
            </h3>
            <button onclick="closeModal()" class="text-slate-400 hover:text-white transition">
                [CLOSE]
            </button>
        </div>
        <div id="modalContent" class="p-6 overflow-y-auto font-mono text-xs text-slate-300 whitespace-pre-wrap flex-1 bg-slate-900/50">
            LOADING CLASSIFIED CONTENT...
        </div>
    </div>
</div>

<nav class="bg-slate-800 border-b border-slate-700 p-4 shrink-0">
    <div class="container mx-auto flex justify-between items-center">
        <h1 class="text-xl font-bold tracking-widest text-emerald-400">MERCENARY // AI</h1>
        <div class="flex items-center gap-4">
            <span class="text-xs text-slate-400">SECURE CONNECTION</span>
            <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
        </div>
    </div>
</nav>

<div class="container mx-auto mt-8 p-4 grid grid-cols-1 md:grid-cols-3 gap-6 flex-1 overflow-hidden">

    <div class="bg-slate-800 p-6 rounded-lg border border-slate-700 shadow-xl h-fit">
        <h2 class="text-lg font-semibold mb-4 text-emerald-500 border-b border-slate-700 pb-2">DATA INGESTION</h2>
        <p class="text-sm text-slate-400 mb-6">Upload intelligence documents (PDF, DOCX) to the secure vector vault.</p>
        <input type="file" id="fileInput" class="hidden" />
        <button onclick="document.getElementById('fileInput').click()"
                class="w-full bg-slate-700 hover:bg-slate-600 text-white py-3 px-4 rounded transition flex items-center justify-center gap-2 border border-slate-600">
            <span>üìÅ</span> Select Document
        </button>
        <div id="uploadStatus" class="mt-4 text-xs text-center text-slate-500 min-h-[20px]"></div>
    </div>

    <div class="md:col-span-2 bg-slate-800 p-6 rounded-lg border border-slate-700 shadow-xl flex flex-col h-[700px]">
        <h2 class="text-lg font-semibold mb-2 text-emerald-500 border-b border-slate-700 pb-2">INTELLIGENCE TERMINAL</h2>
        <div id="chatHistory" class="flex-1 bg-slate-900 rounded p-4 mb-4 overflow-y-auto border border-slate-700 space-y-4">
            <div class="flex flex-col items-start">
                <span class="text-[10px] text-emerald-600 font-mono mb-1">SYSTEM</span>
                <div class="bg-slate-800 p-3 rounded-lg rounded-tl-none border border-slate-700 text-sm text-slate-300 max-w-[80%]">
                    Mercenary Protocol initialized. Ready for queries.
                </div>
            </div>
        </div>
        <div class="flex gap-2 shrink-0">
            <input type="text" id="queryInput" placeholder="Enter query..."
                   class="flex-1 bg-slate-700 border-none text-white rounded p-3 focus:ring-2 focus:ring-emerald-500 outline-none placeholder-slate-500"
                   onkeypress="if(event.key === 'Enter') sendQuery()">
            <button onclick="sendQuery()"
                    class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2 px-6 rounded transition shadow-lg shadow-emerald-900/50">
                SEND
            </button>
        </div>
    </div>
</div>

<script>
    // --- CITATION CLICK HANDLER ---
    document.getElementById('chatHistory').addEventListener('click', function(e) {
        if (e.target.classList.contains('citation-link')) {
            const fileName = e.target.getAttribute('data-file');
            openModal(fileName);
        }
    });

    async function openModal(fileName) {
        const modal = document.getElementById('sourceModal');
        const title = document.getElementById('modalFileName');
        const content = document.getElementById('modalContent');

        modal.classList.remove('hidden');
        title.textContent = fileName;
        content.textContent = "RETRIEVING DATA FRAGMENTS...";

        try {
            const res = await fetch(`/api/inspect?fileName=${encodeURIComponent(fileName)}`);
            const text = await res.text();
            content.textContent = text;
        } catch (err) {
            content.textContent = "ERROR: UNABLE TO DECRYPT FILE.";
        }
    }

    function closeModal() {
        document.getElementById('sourceModal').classList.add('hidden');
    }

    // --- UPLOAD LOGIC ---
    const fileInput = document.getElementById('fileInput');
    const uploadStatus = document.getElementById('uploadStatus');

    fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        uploadStatus.textContent = "UPLOADING: " + file.name + "...";
        uploadStatus.className = "mt-4 text-xs text-center text-yellow-400 animate-pulse";
        const formData = new FormData();
        formData.append("file", file);
        formData.append("dept", "Defense");

        try {
            const response = await fetch('/api/ingest/file', { method: 'POST', body: formData });
            if (response.ok) {
                uploadStatus.textContent = "SUCCESS: " + file.name + " ingested.";
                uploadStatus.className = "mt-4 text-xs text-center text-emerald-400";
            } else {
                uploadStatus.textContent = "ERROR: Upload failed.";
                uploadStatus.className = "mt-4 text-xs text-center text-red-400";
            }
        } catch (error) {
            uploadStatus.textContent = "CRITICAL FAILURE.";
            uploadStatus.className = "mt-4 text-xs text-center text-red-500 font-bold";
        }
    });

    // --- CHAT LOGIC ---
    async function sendQuery() {
        const inputField = document.getElementById('queryInput');
        const question = inputField.value.trim();
        const history = document.getElementById('chatHistory');
        if (!question) return;

        // User Message
        history.innerHTML += `
            <div class="flex flex-col items-end">
                <span class="text-[10px] text-blue-400 font-mono mb-1">OPERATOR</span>
                <div class="bg-blue-900/30 p-3 rounded-lg rounded-tr-none border border-blue-800 text-sm text-white max-w-[80%]">
                    ${question}
                </div>
            </div>`;

        inputField.value = '';
        history.scrollTop = history.scrollHeight;

        try {
            const response = await fetch(`/api/ask?q=${encodeURIComponent(question)}&dept=Defense`);
            let answer = await response.text();

            // --- MAGIC: Convert citations into Clickable Links ---
            // Regex handles "(Source: filename.pdf)" AND "(Source: [filename.pdf])"
            answer = answer.replace(/\(Source: \[?(.*?)\]?\)/g,
                '(Source: <span class="citation-link" data-file="$1">$1</span>)');

            const formattedAnswer = answer.replace(/\n/g, '<br>');

            history.innerHTML += `
                <div class="flex flex-col items-start">
                    <span class="text-[10px] text-emerald-600 font-mono mb-1">AI ANALYST</span>
                    <div class="bg-slate-800 p-3 rounded-lg rounded-tl-none border border-slate-700 text-sm text-slate-300 max-w-[80%] shadow-md">
                        ${formattedAnswer}
                    </div>
                </div>`;
        } catch (error) {
            history.innerHTML += `<div>Error connecting to server.</div>`;
        }
        history.scrollTop = history.scrollHeight;
    }
</script>
</body>
</html>