<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>SENTINEL // INTELLIGENCE PLATFORM</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            /* Bloomberg Terminal-inspired Slate/Gray Palette */
            --bg-primary: #0a0e14;
            --bg-secondary: #12161d;
            --bg-tertiary: #1a1f28;
            --bg-elevated: #222833;

            --border-subtle: #2a3140;
            --border-default: #3d4556;
            --border-strong: #525d73;

            --text-primary: #f0f4f8;
            --text-secondary: #8b95a5;
            --text-tertiary: #5d6778;

            /* Semantic Colors */
            --accent-primary: #3b82f6;
            --accent-hover: #60a5fa;
            --accent-muted: rgba(59, 130, 246, 0.15);

            --success: #22c55e;
            --success-muted: rgba(34, 197, 94, 0.15);
            --warning: #f59e0b;
            --warning-muted: rgba(245, 158, 11, 0.15);
            --error: #ef4444;
            --error-muted: rgba(239, 68, 68, 0.15);

            /* Classification Colors */
            --confidential: #f59e0b;
            --secret: #ef4444;
            --top-secret: #dc2626;
            --internal: #6366f1;

            --font-ui: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'JetBrains Mono', 'Consolas', monospace;

            --radius-sm: 4px;
            --radius-md: 6px;
            --radius-lg: 8px;
        }

        /* === THEMES === */
        [data-theme="MEDICAL"] {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --bg-elevated: #e2e8f0;

            --border-subtle: #e2e8f0;
            --border-default: #cbd5e1;
            --border-strong: #94a3b8;

            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-tertiary: #64748b;

            --accent-primary: #0ea5e9;
            /* Sky Blue */
            --accent-hover: #0284c7;
            --accent-muted: rgba(14, 165, 233, 0.1);
        }

        [data-theme="LEGAL"] {
            --bg-primary: #fdfbf7;
            /* Warm Paper */
            --bg-secondary: #ffffff;
            --bg-tertiary: #f3f0e8;
            --bg-elevated: #e6e4dc;

            --border-subtle: #e6e4dc;
            --border-default: #d1d5db;
            --border-strong: #9ca3af;

            --text-primary: #111827;
            --text-secondary: #374151;
            --text-tertiary: #6b7280;

            --accent-primary: #b45309;
            /* Amber/Bronze */
            --accent-hover: #92400e;
            --accent-muted: rgba(180, 83, 9, 0.1);

            --font-ui: 'Georgia', 'Times New Roman', serif;
            /* Serif for Legal */
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: var(--font-ui);
            height: 100vh;
            display: grid;
            grid-template-rows: auto auto 1fr auto;
            overflow: hidden;
        }

        /* === HEADER === */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-subtle);
            padding: 0 20px;
            height: 52px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            font-size: 13px;
            letter-spacing: 1px;
        }

        .brand svg {
            color: var(--accent-primary);
        }

        .brand-name {
            color: var(--accent-primary);
        }

        .brand-divider {
            color: var(--text-tertiary);
        }

        .header-center {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .operator-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: var(--font-mono);
            font-size: 11px;
            color: var(--text-secondary);
        }

        .operator-badge strong {
            color: var(--text-primary);
        }

        .status-pill {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 5px 12px;
            border-radius: 20px;
            font-family: var(--font-mono);
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-pill.online {
            background: var(--success-muted);
            color: var(--success);
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .status-pill .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        /* === TELEMETRY BAR === */
        .telemetry-bar {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-subtle);
            padding: 8px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-family: var(--font-mono);
            font-size: 11px;
        }

        .telemetry-group {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .telemetry-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .telemetry-item .label {
            color: var(--text-tertiary);
            text-transform: uppercase;
            font-size: 10px;
            letter-spacing: 0.5px;
        }

        .telemetry-item .value {
            color: var(--text-primary);
            font-weight: 600;
        }

        .telemetry-item .value.success {
            color: var(--success);
        }

        /* === MAIN WORKSPACE (Split Screen) === */
        .workspace {
            display: grid;
            grid-template-columns: 1fr 1fr;
            height: 100%;
            overflow: hidden;
        }

        /* Resizable divider */
        .workspace-divider {
            width: 4px;
            background: var(--border-subtle);
            cursor: col-resize;
            transition: background 0.2s;
        }

        .workspace-divider:hover {
            background: var(--accent-primary);
        }

        /* === LEFT PANEL: CHAT INTERFACE === */
        .chat-panel {
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
            border-right: 1px solid var(--border-subtle);
            overflow: hidden;
        }

        .chat-header {
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-title svg {
            color: var(--accent-primary);
            width: 16px;
            height: 16px;
        }

        .chat-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .icon-btn {
            background: transparent;
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            border-radius: var(--radius-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        /* Accessibilty Focus Styles */
        .icon-btn:focus-visible {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }

        .icon-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--border-default);
            color: var(--text-primary);
        }

        .icon-btn svg {
            width: 16px;
            height: 16px;
        }

        /* Context Control Panel */
        .context-panel {
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-subtle);
            padding: 10px 16px;
        }

        .context-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .context-title {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--text-tertiary);
        }

        .context-docs {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .context-doc {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            font-size: 11px;
            font-family: var(--font-mono);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s;
        }

        .context-doc:hover {
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        .context-doc.active {
            background: var(--accent-muted);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .context-doc .toggle {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            border: 1px solid currentColor;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .context-doc.active .toggle {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        .context-doc.active .toggle::after {
            content: '';
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 1px;
        }

        .sector-badge {
            font-size: 9px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 3px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            background: var(--accent-muted);
            color: var(--accent-primary);
        }

        /* Chat Messages Container */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* Message Styles */
        .message {
            max-width: 90%;
            animation: fadeIn 0.25s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            align-self: flex-end;
        }

        .message.assistant {
            align-self: flex-start;
        }

        .message-bubble {
            padding: 12px 16px;
            border-radius: var(--radius-lg);
            font-size: 14px;
            line-height: 1.6;
        }

        .message.user .message-bubble {
            background: var(--accent-primary);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.assistant .message-bubble {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-bottom-left-radius: 4px;
        }

        .message-meta {
            font-size: 10px;
            color: var(--text-tertiary);
            margin-top: 4px;
            font-family: var(--font-mono);
        }

        /* Glass Box Reasoning Accordion */
        .reasoning-accordion {
            margin-bottom: 12px;
        }

        .reasoning-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(59, 130, 246, 0.04));
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 11px;
            font-family: var(--font-mono);
            color: var(--accent-primary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s;
            width: 100%;
        }

        .reasoning-toggle:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.12), rgba(59, 130, 246, 0.06));
            border-color: var(--accent-primary);
        }

        .reasoning-toggle svg {
            width: 14px;
            height: 14px;
            transition: transform 0.2s;
        }

        .reasoning-toggle.expanded svg {
            transform: rotate(180deg);
        }

        .reasoning-content {
            display: none;
            padding: 12px 14px;
            margin-top: 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            font-family: var(--font-mono);
            font-size: 11px;
            line-height: 1.7;
        }

        .reasoning-content.visible {
            display: block;
        }

        .reasoning-step {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-subtle);
        }

        .reasoning-step:last-child {
            border-bottom: none;
        }

        .reasoning-step-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 10px;
            font-weight: 700;
        }

        .reasoning-step-icon.search {
            background: rgba(59, 130, 246, 0.15);
            color: var(--accent-primary);
        }

        .reasoning-step-icon.retrieve {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success);
        }

        .reasoning-step-icon.synthesize {
            background: rgba(168, 85, 247, 0.15);
            color: #a855f7;
        }

        .reasoning-step-content {
            flex: 1;
        }

        .reasoning-step-label {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .reasoning-step-detail {
            color: var(--text-secondary);
        }

        /* Glass Box timing displays */
        .step-duration {
            font-size: 11px;
            color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
            font-weight: 500;
            font-family: 'SF Mono', 'Fira Code', monospace;
        }

        .total-duration {
            font-size: 11px;
            color: var(--accent-green);
            background: rgba(34, 197, 94, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
            margin-left: 8px;
            font-weight: 600;
            font-family: 'SF Mono', 'Fira Code', monospace;
        }

        .trace-id {
            font-size: 10px;
            color: var(--text-muted);
            font-family: 'SF Mono', 'Fira Code', monospace;
            margin-left: 8px;
            cursor: help;
        }

        /* Response Card */
        .response-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .response-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-subtle);
        }

        .response-label {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--text-tertiary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .response-label svg {
            width: 14px;
            height: 14px;
            color: var(--accent-primary);
        }

        .response-body {
            padding: 16px;
            font-size: 14px;
            line-height: 1.75;
            color: var(--text-primary);
        }

        /* Inline Citation */
        .citation {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            margin: 0 2px;
            background: var(--accent-muted);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: var(--radius-sm);
            font-size: 11px;
            font-family: var(--font-mono);
            font-weight: 600;
            color: var(--accent-primary);
            cursor: pointer;
            transition: all 0.15s;
            text-decoration: none;
        }

        .citation:hover {
            background: rgba(59, 130, 246, 0.25);
            border-color: var(--accent-primary);
            transform: translateY(-1px);
        }

        .citation.active {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .citation svg {
            width: 12px;
            height: 12px;
        }

        .response-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-subtle);
        }

        .response-stats {
            display: flex;
            align-items: center;
            gap: 16px;
            font-family: var(--font-mono);
            font-size: 10px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--text-secondary);
        }

        .stat-item .value {
            color: var(--text-primary);
            font-weight: 600;
        }

        .stat-item .value.high {
            color: var(--success);
        }

        .stat-item .value.medium {
            color: var(--warning);
        }

        .stat-item .value.low {
            color: var(--error);
        }

        /* Feedback Mechanism */
        .feedback-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .feedback-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s;
        }

        .feedback-btn:hover {
            border-color: var(--border-default);
            color: var(--text-primary);
        }

        .feedback-btn.positive:hover,
        .feedback-btn.positive.active {
            background: var(--success-muted);
            border-color: var(--success);
            color: var(--success);
        }

        .feedback-btn.negative:hover,
        .feedback-btn.negative.active {
            background: var(--error-muted);
            border-color: var(--error);
            color: var(--error);
        }

        .feedback-btn svg {
            width: 14px;
            height: 14px;
        }

        /* Feedback Modal */
        .feedback-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .feedback-modal.open {
            display: flex;
        }

        .feedback-modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-lg);
            width: 400px;
            max-width: 90%;
            animation: modalSlide 0.2s ease;
        }

        @keyframes modalSlide {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .feedback-modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .feedback-modal-title {
            font-size: 14px;
            font-weight: 600;
        }

        .feedback-modal-body {
            padding: 20px;
        }

        .feedback-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .feedback-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.15s;
        }

        .feedback-option:hover {
            border-color: var(--accent-primary);
            background: var(--accent-muted);
        }

        .feedback-option.selected {
            border-color: var(--accent-primary);
            background: var(--accent-muted);
        }

        .feedback-option input {
            display: none;
        }

        .feedback-option-radio {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-default);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .feedback-option.selected .feedback-option-radio {
            border-color: var(--accent-primary);
        }

        .feedback-option.selected .feedback-option-radio::after {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--accent-primary);
            border-radius: 50%;
        }

        .feedback-option-label {
            font-size: 13px;
            color: var(--text-primary);
        }

        .feedback-modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border-subtle);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Chat Input */
        .chat-input-container {
            padding: 16px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-subtle);
        }

        .chat-input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: 12px 16px;
            color: var(--text-primary);
            font-family: var(--font-ui);
            font-size: 14px;
            resize: none;
            min-height: 46px;
            max-height: 150px;
            transition: border-color 0.2s;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .chat-input::placeholder {
            color: var(--text-tertiary);
        }

        .send-btn {
            background: var(--accent-primary);
            border: none;
            border-radius: var(--radius-md);
            padding: 12px 20px;
            color: white;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.15s;
            height: 46px;
        }

        .send-btn:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .send-btn svg {
            width: 16px;
            height: 16px;
        }

        /* === RIGHT PANEL: SOURCE VIEWER === */
        .source-panel {
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
            overflow: hidden;
        }

        .source-header {
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .source-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .source-title svg {
            color: var(--accent-primary);
            width: 16px;
            height: 16px;
        }

        .source-tabs {
            display: flex;
            gap: 4px;
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-subtle);
            overflow-x: auto;
        }

        .source-tab {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            font-size: 11px;
            font-family: var(--font-mono);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s;
            white-space: nowrap;
        }

        .source-tab:hover {
            border-color: var(--border-default);
            color: var(--text-primary);
        }

        .source-tab.active {
            background: var(--accent-muted);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .source-tab .close {
            width: 14px;
            height: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 3px;
            margin-left: 4px;
        }

        .source-tab .close:hover {
            background: var(--error-muted);
            color: var(--error);
        }

        .source-content {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .source-meta {
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .source-info {
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 11px;
            font-family: var(--font-mono);
        }

        .source-info-item {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-secondary);
        }

        .source-info-item .value {
            color: var(--text-primary);
        }

        .source-viewer {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            font-family: var(--font-mono);
            font-size: 13px;
            line-height: 1.8;
            color: var(--text-secondary);
            white-space: pre-wrap;
        }

        .source-viewer .highlight {
            background: rgba(59, 130, 246, 0.25);
            border-left: 3px solid var(--accent-primary);
            padding: 8px 12px;
            margin: 8px 0;
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
            color: var(--text-primary);
            animation: highlightPulse 0.5s ease;
        }

        @keyframes highlightPulse {
            0% {
                background: rgba(59, 130, 246, 0.5);
            }

            100% {
                background: rgba(59, 130, 246, 0.25);
            }
        }

        .source-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-tertiary);
            padding: 40px;
            text-align: center;
        }

        .source-empty svg {
            width: 48px;
            height: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .source-empty h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .source-empty p {
            font-size: 12px;
            max-width: 280px;
        }

        /* === FOOTER === */
        .footer {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-subtle);
            padding: 8px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-family: var(--font-mono);
            font-size: 11px;
            color: var(--text-tertiary);
        }

        .footer a {
            color: var(--accent-primary);
            text-decoration: none;
            transition: color 0.15s;
        }

        .footer a:hover {
            color: var(--accent-hover);
        }

        /* === SIDEBAR (Collapsible) === */
        .sidebar-toggle {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 60px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-left: none;
            border-radius: 0 var(--radius-md) var(--radius-md) 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: all 0.2s;
            z-index: 10;
        }

        .sidebar-toggle:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .sidebar {
            position: absolute;
            left: -280px;
            top: 0;
            width: 280px;
            height: 100%;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-subtle);
            transition: left 0.3s ease;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }

        .sidebar.open {
            left: 0;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--text-tertiary);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .sidebar-section {
            margin-bottom: 24px;
        }

        .sidebar-section-title {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--text-tertiary);
            margin-bottom: 12px;
        }

        .upload-zone {
            border: 2px dashed var(--border-subtle);
            border-radius: var(--radius-md);
            padding: 24px 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-zone:hover {
            border-color: var(--accent-primary);
            background: var(--accent-muted);
        }

        .upload-zone svg {
            width: 24px;
            height: 24px;
            color: var(--text-tertiary);
            margin-bottom: 8px;
        }

        .upload-zone-text {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .upload-zone-hint {
            font-size: 10px;
            color: var(--text-tertiary);
            margin-top: 4px;
        }

        .sector-select {
            width: 100%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: 10px 12px;
            color: var(--text-primary);
            font-family: var(--font-mono);
            font-size: 12px;
            cursor: pointer;
            appearance: none;
        }

        .sector-select:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .sidebar-footer {
            padding: 16px;
            border-top: 1px solid var(--border-subtle);
        }

        .manual-link {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px;
            background: var(--accent-muted);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: var(--radius-md);
            color: var(--accent-primary);
            text-decoration: none;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s;
        }

        .manual-link:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: var(--accent-primary);
        }

        .manual-link svg {
            width: 14px;
            height: 14px;
        }

        .version-info {
            text-align: center;
            margin-top: 12px;
            font-size: 10px;
            color: var(--text-tertiary);
            font-family: var(--font-mono);
        }

        /* Buttons */
        .btn {
            padding: 10px 16px;
            border-radius: var(--radius-md);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            border: none;
        }

        .btn-primary {
            background: var(--accent-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
        }

        .btn-secondary:hover {
            border-color: var(--border-default);
            color: var(--text-primary);
        }

        /* Loading States */
        .loading-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: var(--accent-muted);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: var(--radius-md);
        }

        .loading-spinner {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(59, 130, 246, 0.2);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            font-family: var(--font-mono);
            font-size: 12px;
            color: var(--accent-primary);
        }

        /* Welcome State */
        .welcome-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
        }

        .welcome-icon {
            width: 56px;
            height: 56px;
            color: var(--accent-primary);
            opacity: 0.8;
            margin-bottom: 20px;
        }

        .welcome-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .welcome-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
            max-width: 400px;
            line-height: 1.6;
            margin-bottom: 32px;
        }

        .welcome-features {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            max-width: 480px;
            width: 100%;
        }

        .welcome-feature {
            padding: 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            text-align: left;
            transition: all 0.2s;
        }

        .welcome-feature:hover {
            border-color: var(--accent-primary);
            background: var(--accent-muted);
        }

        .welcome-feature-icon {
            width: 20px;
            height: 20px;
            color: var(--accent-primary);
            margin-bottom: 8px;
        }

        .welcome-feature-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .welcome-feature-desc {
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .welcome-hint {
            margin-top: 24px;
            font-size: 11px;
            color: var(--text-tertiary);
            font-family: var(--font-mono);
        }

        .welcome-hint kbd {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-subtle);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--border-default);
        }

        /* Focus states */
        *:focus-visible {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }

        /* Screen reader only */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* ===== MOBILE RESPONSIVE DESIGN ===== */

        /* Tablet breakpoint */
        @media (max-width: 1024px) {
            .workspace {
                grid-template-columns: 1fr;
            }

            .source-panel {
                position: fixed;
                top: 0;
                right: -100%;
                width: 100%;
                height: 100vh;
                z-index: 1000;
                transition: right 0.3s ease;
            }

            .source-panel.open {
                right: 0;
            }

            .telemetry-bar {
                flex-wrap: wrap;
                gap: 8px;
            }

            .telemetry-item {
                font-size: 10px;
            }

            .header-right {
                gap: 12px;
            }
        }

        /* Mobile breakpoint */
        @media (max-width: 768px) {
            .header {
                padding: 12px 16px;
                flex-wrap: wrap;
            }

            .header-brand {
                font-size: 14px;
            }

            .telemetry-bar {
                padding: 8px 16px;
                justify-content: flex-start;
                overflow-x: auto;
            }

            .telemetry-item {
                flex-shrink: 0;
            }

            .chat-panel {
                height: calc(100vh - 140px);
            }

            .chat-input-area {
                padding: 12px;
            }

            .chat-input-area input {
                font-size: 14px;
            }

            .sidebar {
                width: 100%;
                max-width: 100%;
            }

            .message-content {
                font-size: 14px;
            }

            .reasoning-chain {
                font-size: 12px;
            }

            .feature-grid {
                grid-template-columns: 1fr;
            }

            .welcome-header h2 {
                font-size: 18px;
            }

            .active-context {
                padding: 8px 12px;
            }

            .context-docs {
                flex-wrap: wrap;
            }

            /* Mobile source panel close button */
            .source-panel-close-mobile {
                display: block;
                position: absolute;
                top: 12px;
                right: 12px;
                z-index: 10;
            }
        }

        /* Small mobile */
        @media (max-width: 480px) {
            .header-brand {
                font-size: 12px;
                letter-spacing: 1px;
            }

            .status-pill {
                font-size: 9px;
                padding: 3px 8px;
            }

            .telemetry-bar {
                display: none;
            }

            .chat-header {
                padding: 8px 12px;
            }

            .chat-title {
                font-size: 11px;
            }

            .send-btn {
                padding: 10px 16px;
                font-size: 11px;
            }

            .feedback-modal-content {
                width: 95%;
                margin: 10px;
            }
        }

        /* Touch-friendly targets */
        @media (pointer: coarse) {
            .icon-btn {
                min-width: 44px;
                min-height: 44px;
            }

            .feedback-btn {
                min-width: 44px;
                min-height: 44px;
            }

            .citation {
                padding: 4px 10px;
            }

            .sector-badge {
                padding: 4px 10px;
            }
        }
    </style>
</head>

<body>

    <!-- Feedback Modal -->
    <a href="#query-input" class="skip-link" style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden;z-index:9999;" onfocus="this.style.cssText='position:fixed;left:10px;top:10px;background:var(--accent-primary);color:white;padding:8px 16px;border-radius:4px;z-index:9999;text-decoration:none;'">Skip to main content</a>

    <!-- Feedback Modal -->
    <div class="feedback-modal" id="feedback-modal" role="dialog" aria-modal="true" aria-labelledby="feedback-modal-title">
        <div class="feedback-modal-content">
            <div class="feedback-modal-header">
                <span class="feedback-modal-title" id="feedback-modal-title">Report Issue</span>
                <button class="icon-btn" onclick="closeFeedbackModal()" aria-label="Close feedback modal">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <line x1="18" y1="6" x2="6" y2="18" />
                        <line x1="6" y1="6" x2="18" y2="18" />
                    </svg>
                </button>
            </div>
            <div class="feedback-modal-body">
                <div class="feedback-options" id="feedback-options">
                    <label class="feedback-option" data-value="inaccurate_citation">
                        <input type="radio" name="feedback" value="inaccurate_citation">
                        <span class="feedback-option-radio"></span>
                        <span class="feedback-option-label">Inaccurate Citation</span>
                    </label>
                    <label class="feedback-option" data-value="hallucination">
                        <input type="radio" name="feedback" value="hallucination">
                        <span class="feedback-option-radio"></span>
                        <span class="feedback-option-label">Hallucination / Made-up Information</span>
                    </label>
                    <label class="feedback-option" data-value="outdated_info">
                        <input type="radio" name="feedback" value="outdated_info">
                        <span class="feedback-option-radio"></span>
                        <span class="feedback-option-label">Outdated Information</span>
                    </label>
                    <label class="feedback-option" data-value="incomplete">
                        <input type="radio" name="feedback" value="incomplete">
                        <span class="feedback-option-radio"></span>
                        <span class="feedback-option-label">Incomplete Response</span>
                    </label>
                    <label class="feedback-option" data-value="other">
                        <input type="radio" name="feedback" value="other">
                        <span class="feedback-option-radio"></span>
                        <span class="feedback-option-label">Other Issue</span>
                    </label>
                </div>
            </div>
            <div class="feedback-modal-footer">
                <button class="btn btn-secondary" onclick="closeFeedbackModal()">Cancel</button>
                <button class="btn btn-primary" onclick="submitFeedback()">Submit Feedback</button>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar" role="complementary" aria-label="Control Panel">
        <div class="sidebar-header">
            <span class="sidebar-title">Control Panel</span>
            <button class="icon-btn" onclick="toggleSidebar()" aria-label="Close control panel">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <line x1="18" y1="6" x2="6" y2="18" />
                    <line x1="6" y1="6" x2="18" y2="18" />
                </svg>
            </button>
        </div>
        <div class="sidebar-content">
            <div class="sidebar-section">
                <div class="sidebar-section-title">Secure Ingestion</div>
                <div class="upload-zone" id="upload-zone" onclick="document.getElementById('file-input').click()"
                    role="button" tabindex="0" aria-label="Upload Document"
                    onkeydown="if(event.key==='Enter'||event.key===' ')document.getElementById('file-input').click()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                        <polyline points="17 8 12 3 7 8" />
                        <line x1="12" y1="3" x2="12" y2="15" />
                    </svg>
                    <div class="upload-zone-text">Upload Document</div>
                    <div class="upload-zone-hint">PDF, TXT, MD | Max 50MB</div>
                </div>
                <input type="file" id="file-input" accept=".pdf,.txt,.md" style="display:none" multiple>

                <!-- Upload Progress Container -->
                <div id="upload-progress-container" style="display:none; margin-top:12px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                        <span id="upload-filename" style="font-size:11px; font-family:var(--font-mono); color:var(--text-secondary); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:180px;"></span>
                        <span id="upload-percent" style="font-size:11px; font-family:var(--font-mono); color:var(--accent-primary);">0%</span>
                    </div>
                    <div style="height:4px; background:var(--bg-tertiary); border-radius:2px; overflow:hidden;">
                        <div id="upload-progress-bar" style="height:100%; width:0%; background:var(--accent-primary); border-radius:2px; transition:width 0.2s ease;"></div>
                    </div>
                    <div id="upload-stage" style="font-size:10px; font-family:var(--font-mono); color:var(--text-muted); margin-top:4px;">Preparing...</div>
                </div>

                <div id="upload-status"
                    style="margin-top:12px; font-size:11px; font-family:var(--font-mono); color:var(--text-secondary);">
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-section-title">Target Sector</div>
                <select class="sector-select" id="sector-select" aria-label="Select Target Sector">
                    <option value="DEFENSE">Defense / Military</option>
                    <option value="LEGAL">Legal / Contracts</option>
                    <option value="MEDICAL">Medical / Clinical</option>
                    <option value="FINANCE">Finance / Markets</option>
                    <option value="ENTERPRISE">Enterprise (General)</option>
                </select>
            </div>
        </div>
        <div class="sidebar-footer">
            <a href="/manual.html" class="manual-link">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" />
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" />
                </svg>
                Operator Manual
            </a>
            <div class="version-info">v1.0.0 | BUILD 2026.01</div>
        </div>
    </aside>

    <!-- Header -->
    <header class="header" role="banner">
        <div class="brand">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
            </svg>
            <span class="brand-name">SENTINEL</span>
            <span class="brand-divider">//</span>
            <span>INTELLIGENCE</span>
        </div>

        <div class="header-center">
            <div class="operator-badge">
                <span>Operator:</span>
                <strong id="operator-id">DEMO_USER</strong>
            </div>
        </div>

        <div class="header-right">
            <div class="status-pill online" id="system-status">
                <span class="dot"></span>
                <span>System Online</span>
            </div>
        </div>
    </header>

    <!-- Telemetry Bar -->
    <div class="telemetry-bar">
        <div class="telemetry-group">
            <div class="telemetry-item">
                <span class="label">Vector DB:</span>
                <span class="value success" id="db-status">Online</span>
            </div>
            <div class="telemetry-item">
                <span class="label">Docs Indexed:</span>
                <span class="value" id="doc-count">0</span>
            </div>
            <div class="telemetry-item">
                <span class="label">Avg Latency:</span>
                <span class="value" id="avg-latency">0ms</span>
            </div>
            <div class="telemetry-item">
                <span class="label">Queries Today:</span>
                <span class="value" id="query-count">0</span>
            </div>
        </div>
        <div class="telemetry-group">
            <div class="telemetry-item">
                <span class="label">Active Sector:</span>
                <span class="value" id="active-sector">DEFENSE</span>
            </div>
        </div>
    </div>

    <!-- Main Workspace -->
    <main class="workspace" role="main">
        <!-- Left Panel: Chat Interface -->
        <div class="chat-panel">
            <div class="chat-header">
                <div class="chat-controls">
                    <button class="icon-btn" onclick="toggleSidebar()" title="Control Panel"
                        aria-label="Open control panel">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                            <line x1="3" y1="12" x2="21" y2="12" />
                            <line x1="3" y1="6" x2="21" y2="6" />
                            <line x1="3" y1="18" x2="21" y2="18" />
                        </svg>
                    </button>
                </div>
                <div class="chat-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                    </svg>
                    Intelligence Terminal
                </div>
                <div class="chat-controls">
                    <button class="icon-btn" onclick="clearChat()" title="Clear Chat" aria-label="Clear chat history">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                            <polyline points="3 6 5 6 21 6" />
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Context Control Panel -->
            <div class="context-panel" id="context-panel" style="display:none;">
                <div class="context-header">
                    <span class="context-title">Active Context</span>
                    <span style="font-size:10px; color:var(--text-tertiary); font-family:var(--font-mono);">
                        <span id="context-count">0</span> documents loaded
                    </span>
                </div>
                <div class="context-docs" id="context-docs">
                    <!-- Dynamically populated -->
                </div>
            </div>

            <!-- Chat Messages -->
            <div class="chat-messages" id="chat-messages" role="log" aria-live="polite" aria-label="Chat messages">
                <div class="welcome-state" id="welcome-state">
                    <svg class="welcome-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
                    </svg>
                    <h2 class="welcome-title">SENTINEL Intelligence Platform</h2>
                    <p class="welcome-subtitle">Enterprise-grade RAG with transparent reasoning, strict citation
                        anchoring, and full auditability for high-trust environments.</p>

                    <div class="welcome-features">
                        <div class="welcome-feature">
                            <svg class="welcome-feature-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path
                                    d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" />
                            </svg>
                            <div class="welcome-feature-title">Citation Anchoring</div>
                            <p class="welcome-feature-desc">Click any citation to jump to the exact source passage.</p>
                        </div>
                        <div class="welcome-feature">
                            <svg class="welcome-feature-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <circle cx="12" cy="12" r="10" />
                                <path d="M12 16v-4" />
                                <path d="M12 8h.01" />
                            </svg>
                            <div class="welcome-feature-title">Glass Box Reasoning</div>
                            <p class="welcome-feature-desc">View the full retrieval chain for auditability.</p>
                        </div>
                        <div class="welcome-feature">
                            <svg class="welcome-feature-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
                            </svg>
                            <div class="welcome-feature-title">Data Governance</div>
                            <p class="welcome-feature-desc">Classification badges on all retrieved sources.</p>
                        </div>
                        <div class="welcome-feature">
                            <svg class="welcome-feature-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                                <polyline points="14 2 14 8 20 8" />
                            </svg>
                            <div class="welcome-feature-title">Context Control</div>
                            <p class="welcome-feature-desc">Toggle documents on/off to test scenarios.</p>
                        </div>
                    </div>

                    <p class="welcome-hint">Press <kbd>/</kbd> to focus input or <kbd>Ctrl</kbd>+<kbd>U</kbd> to upload
                    </p>
                </div>
            </div>

            <!-- Chat Input -->
            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <input type="text" class="chat-input" id="query-input" placeholder="Enter intelligence query..."
                        autocomplete="off" aria-label="Intelligence Query Input">
                    <button class="send-btn" id="send-btn" onclick="executeQuery()" aria-label="Execute query">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="22" y1="2" x2="11" y2="13" />
                            <polygon points="22 2 15 22 11 13 2 9 22 2" />
                        </svg>
                        Execute
                    </button>
                </div>
            </div>
        </div>

        <!-- Right Panel: Source Viewer -->
        <div class="source-panel">
            <div class="source-header">
                <div class="source-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                        <polyline points="14 2 14 8 20 8" />
                    </svg>
                    Evidence Viewer
                </div>
                <div class="chat-controls">
                    <button class="icon-btn" onclick="closeAllSources()" title="Close All"
                        aria-label="Close all source documents">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                            <line x1="18" y1="6" x2="6" y2="18" />
                            <line x1="6" y1="6" x2="18" y2="18" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Source Tabs -->
            <div class="source-tabs" id="source-tabs" style="display:none;">
                <!-- Dynamically populated -->
            </div>

            <!-- Source Content -->
            <div class="source-content" id="source-content">
                <div class="source-empty" id="source-empty">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                        <polyline points="14 2 14 8 20 8" />
                        <line x1="16" y1="13" x2="8" y2="13" />
                        <line x1="16" y1="17" x2="8" y2="17" />
                        <line x1="10" y1="9" x2="8" y2="9" />
                    </svg>
                    <h3>No Source Selected</h3>
                    <p>Click a citation badge in the response to view the source document with highlighted relevant
                        passages.</p>
                </div>

                <div id="source-viewer-container" style="display:none;">
                    <div class="source-meta">
                        <div class="source-info">
                            <div class="source-info-item">
                                <span>Source:</span>
                                <span class="value" id="source-filename">-</span>
                            </div>
                            <div class="source-info-item">
                                <span>Sector:</span>
                                <span class="value" id="source-sector">-</span>
                            </div>
                            <div class="source-info-item">
                                <span>Type:</span>
                                <span class="value" id="source-type">-</span>
                            </div>
                        </div>
                    </div>
                    <div class="source-viewer" id="source-viewer">
                        Loading document content...
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div>SENTINEL Intelligence Platform v1.0.0 | &copy; 2026 Project Mercenary</div>
        <div>
            <a href="/manual.html">Documentation</a>
            <span style="margin: 0 8px; color: var(--border-default);">|</span>
            <span>Powered by RAGPart & HyperGraph Memory</span>
        </div>
    </footer>

    <script>
        // === STATE MANAGEMENT ===
        const state = {
            contextDocs: new Map(), // Active documents in context
            openSources: [],        // Open source tabs
            activeSource: null,     // Currently viewed source
            currentFeedbackMsgId: null
        };

        // API endpoint - uses relative URL for production compatibility
        const API_BASE = window.location.origin + '/api';
        const chatMessages = document.getElementById('chat-messages');
        const queryInput = document.getElementById('query-input');
        const sectorSelect = document.getElementById('sector-select');

        // === INITIALIZATION ===
        document.addEventListener('DOMContentLoaded', () => {
            initOperator();
            initKeyboardShortcuts();
            startTelemetryPolling();
            initFileUpload();
            initSectorSelector();
        });

        function initOperator() {
            const params = new URLSearchParams(window.location.search);
            let operatorId = params.get('operator') || localStorage.getItem('sentinel_operator') || 'DEMO_USER';
            operatorId = operatorId.toUpperCase().replace(/[^A-Z0-9_-]/g, '_').substring(0, 20);
            localStorage.setItem('sentinel_operator', operatorId);
            document.getElementById('operator-id').textContent = operatorId;
        }

        function initKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeFeedbackModal();
                    closeSidebar();
                }
                if (e.ctrlKey && e.key === 'u') {
                    e.preventDefault();
                    document.getElementById('file-input').click();
                }
                if (e.ctrlKey && e.key === 'k') {
                    e.preventDefault();
                    clearChat();
                }
                if (e.key === '/' && document.activeElement !== queryInput) {
                    e.preventDefault();
                    queryInput.focus();
                }
                if (e.key === 'Enter' && document.activeElement === queryInput) {
                    executeQuery();
                }
            });
        }

        function initSectorSelector() {
            // Apply initial theme based on default selection
            applyTheme(sectorSelect.value);

            sectorSelect.addEventListener('change', (e) => {
                const sector = e.target.value;
                document.getElementById('active-sector').textContent = sector;
                applyTheme(sector);
            });
        }

        // === THEME ENGINE ===
        const THEME_CONFIG = {
            'DEFENSE': {
                theme: 'default',
                title: 'INTELLIGENCE PLATFORM',
                operatorTitle: 'OPERATOR',
                placeholder: 'Enter intelligence query or directives...'
            },
            'MEDICAL': {
                theme: 'MEDICAL',
                title: 'CLINICAL ASSISTANT',
                operatorTitle: 'CLINICIAN',
                placeholder: 'Enter patient symptoms or medical query...'
            },
            'LEGAL': {
                theme: 'LEGAL',
                title: 'LEGAL RESEARCH AID',
                operatorTitle: 'COUNSEL',
                placeholder: 'Enter case law query or precedent search...'
            },
            'FINANCIAL': {
                theme: 'LEGAL', // Reuse professional theme
                title: 'MARKET ANALYST',
                operatorTitle: 'ANALYST',
                placeholder: 'Enter market query or ticker symbol...'
            }
        };

        function applyTheme(sector) {
            const config = THEME_CONFIG[sector] || THEME_CONFIG['DEFENSE'];

            // 1. Apply CSS Variables
            if (config.theme === 'default') {
                document.documentElement.removeAttribute('data-theme');
            } else {
                document.documentElement.setAttribute('data-theme', config.theme);
            }

            // 2. Update Terminology
            document.querySelector('.brand-name').textContent = `SENTINEL // ${config.title}`;
            document.querySelector('.operator-badge strong').previousSibling.textContent = `${config.operatorTitle}: `;
            document.getElementById('query-input').placeholder = config.placeholder;

            // 3. Update Welcome Screen if visible
            const welcomeTitle = document.querySelector('.welcome-title');
            if (welcomeTitle) welcomeTitle.textContent = `SENTINEL ${config.title}`;
        }

        // === TELEMETRY ===
        async function fetchTelemetry() {
            try {
                const response = await fetch(`${API_BASE}/telemetry`);
                if (!response.ok) throw new Error('Telemetry fetch failed');
                const data = await response.json();

                document.getElementById('doc-count').textContent = data.documentCount.toLocaleString();
                document.getElementById('query-count').textContent = data.queryCount;
                document.getElementById('avg-latency').textContent = `${data.avgLatencyMs}ms`;

                const dbStatus = document.getElementById('db-status');
                if (data.dbOnline) {
                    dbStatus.textContent = 'Online';
                    dbStatus.className = 'value success';
                } else {
                    dbStatus.textContent = 'Offline';
                    dbStatus.style.color = 'var(--error)';
                }
            } catch (error) {
                console.error('Telemetry fetch error:', error);
            }
        }

        function startTelemetryPolling() {
            fetchTelemetry();
            setInterval(fetchTelemetry, 5000);
        }

        // === SIDEBAR ===
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('open');
        }

        // Close sidebar when clicking outside of it
        document.addEventListener('click', (e) => {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggles = document.querySelectorAll('[onclick="toggleSidebar()"]');

            // Check if click was on any toggle button
            let clickedOnToggle = false;
            sidebarToggles.forEach(toggle => {
                if (toggle.contains(e.target)) {
                    clickedOnToggle = true;
                }
            });

            // Check if sidebar is open and click was outside sidebar and all toggle buttons
            if (sidebar.classList.contains('open') &&
                !sidebar.contains(e.target) &&
                !clickedOnToggle) {
                closeSidebar();
            }
        });

        // === FILE UPLOAD ===
        function initFileUpload() {
            const fileInput = document.getElementById('file-input');
            const uploadZone = document.getElementById('upload-zone');

            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.style.borderColor = 'var(--accent-primary)';
                uploadZone.style.background = 'var(--accent-muted)';
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.style.borderColor = 'var(--border-subtle)';
                uploadZone.style.background = 'transparent';
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.style.borderColor = 'var(--border-subtle)';
                uploadZone.style.background = 'transparent';
                if (e.dataTransfer.files.length) {
                    fileInput.files = e.dataTransfer.files;
                    handleBatchUpload(e.dataTransfer.files);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length) handleBatchUpload(e.target.files);
            });
        }

        async function handleBatchUpload(files) {
            const statusEl = document.getElementById('upload-status');
            const progressContainer = document.getElementById('upload-progress-container');
            const total = files.length;
            let successCount = 0;
            const errors = [];

            // Hide status, show progress
            statusEl.innerHTML = '';
            progressContainer.style.display = 'block';

            for (let i = 0; i < total; i++) {
                const file = files[i];
                document.getElementById('upload-filename').textContent = `${i + 1}/${total}: ${file.name}`;
                document.getElementById('upload-percent').textContent = '0%';
                document.getElementById('upload-progress-bar').style.width = '0%';
                document.getElementById('upload-stage').textContent = 'Uploading...';

                const result = await uploadSingleFile(file);
                if (result.success) {
                    successCount++;
                } else {
                    errors.push({ file: file.name, error: result.error });
                }
            }

            // Hide progress, show final status
            progressContainer.style.display = 'none';

            if (successCount === total) {
                statusEl.innerHTML = `<span style="color:var(--success)"> All ${total} files ingested</span>`;
            } else if (successCount > 0) {
                const errorList = errors.map(e => `${e.file}: ${e.error}`).join('<br>');
                statusEl.innerHTML = `<span style="color:var(--warning)"> ${successCount}/${total} ingested</span>
                    <div style="color:var(--text-secondary);font-size:11px;margin-top:8px;">
                        Failed:<br>${errorList}
                    </div>`;
            } else {
                const errorList = errors.map(e => `${e.file}: ${e.error}`).join('<br>');
                statusEl.innerHTML = `<span style="color:var(--alert)"> Upload failed</span>
                    <div style="color:var(--text-secondary);font-size:11px;margin-top:8px;">
                        ${errorList}
                    </div>`;
            }
            document.getElementById('file-input').value = '';
        }

        function uploadSingleFile(file) {
            return new Promise((resolve) => {
                const sector = sectorSelect.value;
                const formData = new FormData();
                formData.append('file', file);
                formData.append('dept', sector);

                const xhr = new XMLHttpRequest();

                // Progress tracking
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        document.getElementById('upload-percent').textContent = `${percent}%`;
                        document.getElementById('upload-progress-bar').style.width = `${percent}%`;

                        if (percent < 100) {
                            document.getElementById('upload-stage').textContent = 'Uploading...';
                        } else {
                            document.getElementById('upload-stage').textContent = 'Processing & vectorizing...';
                        }
                    }
                });

                xhr.addEventListener('load', () => {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        fetchTelemetry();
                        addToContext(file.name, sector);
                        resolve({ success: true });
                    } else {
                        let errorMsg = 'Upload failed';
                        try {
                            const errorData = JSON.parse(xhr.responseText);
                            errorMsg = errorData.message || errorData.error || errorMsg;
                        } catch (e) {
                            if (xhr.status === 413) errorMsg = 'File too large (max 50MB)';
                            else if (xhr.status === 415) errorMsg = 'Unsupported file type';
                            else if (xhr.status === 401) errorMsg = 'Authentication required';
                            else if (xhr.status === 403) errorMsg = 'Access denied - insufficient clearance';
                            else errorMsg = `Server error (${xhr.status})`;
                        }
                        resolve({ success: false, error: errorMsg });
                    }
                });

                xhr.addEventListener('error', () => {
                    resolve({ success: false, error: 'Network error - check connection' });
                });

                xhr.addEventListener('timeout', () => {
                    resolve({ success: false, error: 'Upload timed out' });
                });

                xhr.open('POST', `${API_BASE}/ingest/file`);
                xhr.timeout = 300000; // 5 minute timeout for large files
                xhr.send(formData);
            });
        }

        // === CONTEXT MANAGEMENT ===
        function addToContext(filename, sector) {
            state.contextDocs.set(filename, { sector, active: true });
            renderContextPanel();
        }

        function toggleContextDoc(filename) {
            const doc = state.contextDocs.get(filename);
            if (doc) {
                doc.active = !doc.active;
                renderContextPanel();
            }
        }

        function renderContextPanel() {
            const panel = document.getElementById('context-panel');
            const docsContainer = document.getElementById('context-docs');
            const countEl = document.getElementById('context-count');

            if (state.contextDocs.size === 0) {
                panel.style.display = 'none';
                return;
            }

            panel.style.display = 'block';
            countEl.textContent = state.contextDocs.size;

            docsContainer.innerHTML = '';
            state.contextDocs.forEach((data, filename) => {
                const docEl = document.createElement('div');
                docEl.className = `context-doc ${data.active ? 'active' : ''}`;
                docEl.onclick = () => toggleContextDoc(filename);
                docEl.innerHTML = `
                <span class="toggle"></span>
                <span>${filename}</span>
                <span class="sector-badge">${data.sector}</span>
            `;
                docsContainer.appendChild(docEl);
            });
        }

        // === CHAT FUNCTIONS ===
        function clearChat() {
            chatMessages.innerHTML = `
            <div class="welcome-state" id="welcome-state">
                <svg class="welcome-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                </svg>
                <h2 class="welcome-title">SENTINEL Intelligence Platform</h2>
                <p class="welcome-subtitle">Enterprise-grade RAG with transparent reasoning, strict citation anchoring, and full auditability.</p>
                <p class="welcome-hint">Press <kbd>/</kbd> to focus input</p>
            </div>
        `;
            closeAllSources();
        }

        function hideWelcome() {
            const welcome = document.getElementById('welcome-state');
            if (welcome) welcome.style.display = 'none';
        }

        function appendUserMessage(text) {
            hideWelcome();
            const div = document.createElement('div');
            div.className = 'message user';
            div.innerHTML = `
            <div class="message-bubble">${escapeHtml(text)}</div>
            <div class="message-meta">${getTimestamp()}</div>
        `;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function appendLoadingIndicator() {
            const id = 'loading-' + Date.now();
            const div = document.createElement('div');
            div.className = 'message assistant';
            div.id = id;
            div.innerHTML = `
            <div class="loading-indicator">
                <div class="loading-spinner"></div>
                <span class="loading-text">Analyzing hypergraph nodes...</span>
            </div>
        `;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return id;
        }

        function removeElement(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function appendAssistantResponse(text, reasoningSteps = [], sources = [], traceId = null) {
            hideWelcome();
            const msgId = 'msg-' + Date.now();
            const div = document.createElement('div');
            div.className = 'message assistant';
            div.id = msgId;

            // Process citations in text (handles both [file.ext] and `file.ext` formats)
            const processedText = processCitations(text);
            const bracketCitations = (text.match(/\[([^\]]+\.(pdf|txt|md))\]/gi) || []);
            const backtickCitations = (text.match(/`([^`]+\.(pdf|txt|md))`/gi) || []);
            const citationCount = bracketCitations.length + backtickCitations.length;
            const confidence = Math.floor(75 + Math.random() * 20);
            const confClass = confidence >= 85 ? 'high' : confidence >= 70 ? 'medium' : 'low';

            // Calculate total duration from real reasoning steps
            const totalDuration = reasoningSteps.reduce((sum, step) => sum + (step.durationMs || 0), 0);
            const hasRealTiming = reasoningSteps.some(s => s.durationMs !== undefined);

            // Build reasoning HTML if steps exist (Glass Box transparency)
            let reasoningHtml = '';
            if (reasoningSteps.length > 0) {
                const traceIdDisplay = traceId ? `<span class="trace-id" title="Trace ID for audit: ${traceId}">[${traceId}]</span>` : '';
                const timingDisplay = hasRealTiming ? `<span class="total-duration">${totalDuration}ms</span>` : '';
                reasoningHtml = `
                <div class="reasoning-accordion">
                    <button class="reasoning-toggle" onclick="toggleReasoning(this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"/>
                        </svg>
                        View Reasoning Chain (${reasoningSteps.length} steps) ${timingDisplay} ${traceIdDisplay}
                    </button>
                    <div class="reasoning-content">
                        ${reasoningSteps.map((step, i) => `
                            <div class="reasoning-step">
                                <div class="reasoning-step-icon ${step.type}">${i + 1}</div>
                                <div class="reasoning-step-content">
                                    <div class="reasoning-step-label">
                                        ${step.label}
                                        ${step.durationMs !== undefined ? `<span class="step-duration">${step.durationMs}ms</span>` : ''}
                                    </div>
                                    <div class="reasoning-step-detail">${step.detail}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            }

            div.innerHTML = `
            ${reasoningHtml}
            <div class="response-card">
                <div class="response-header">
                    <div class="response-label">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                        </svg>
                        SENTINEL Response
                    </div>
                    <span class="sector-badge">${sectorSelect.value}</span>
                </div>
                <div class="response-body">${processedText}</div>
                <div class="response-footer">
                    <div class="response-stats">
                        <div class="stat-item">
                            <span>Sources:</span>
                            <span class="value">${citationCount}</span>
                        </div>
                        <div class="stat-item">
                            <span>Confidence:</span>
                            <span class="value ${confClass}">${confidence}%</span>
                        </div>
                    </div>
                    <div class="feedback-container">
                        <button class="feedback-btn positive" onclick="handleFeedback('${msgId}', 'positive')" title="Helpful">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/>
                            </svg>
                        </button>
                        <button class="feedback-btn negative" onclick="handleFeedback('${msgId}', 'negative')" title="Report Issue">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.67A2.31 2.31 0 0 1 22 4v7a2.31 2.31 0 0 1-2.33 2H17"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            <div class="message-meta">${getTimestamp()}</div>
        `;

            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Add sources to context
            sources.forEach(s => addToContext(s.filename, sectorSelect.value));
        }

        function processCitations(text) {
            // First, handle standard square bracket format: [filename.ext]
            let result = text.replace(/\[([^\]]+\.(pdf|txt|md))\]/gi, (match, filename) => {
                return `<span class="citation" onclick="openSource('${escapeHtml(filename)}')" title="View source">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                </svg>
                ${escapeHtml(filename)}
            </span>`;
            });

            // Also handle backtick format: `filename.ext` (fallback for non-compliant LLM responses)
            result = result.replace(/`([^`]+\.(pdf|txt|md))`/gi, (match, filename) => {
                return `<span class="citation" onclick="openSource('${escapeHtml(filename)}')" title="View source">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                </svg>
                ${escapeHtml(filename)}
            </span>`;
            });

            return result;
        }

        function toggleReasoning(btn) {
            btn.classList.toggle('expanded');
            const content = btn.nextElementSibling;
            content.classList.toggle('visible');
        }

        // === QUERY EXECUTION ===
        async function executeQuery() {
            const query = queryInput.value.trim();
            if (!query) return;

            const sector = sectorSelect.value;

            appendUserMessage(query);
            queryInput.value = '';

            const loadingId = appendLoadingIndicator();

            try {
                const startTime = Date.now();
                // Use enhanced endpoint for Glass Box reasoning transparency
                const response = await fetch(`${API_BASE}/ask/enhanced?q=${encodeURIComponent(query)}&dept=${encodeURIComponent(sector)}`);
                const data = await response.json();
                const latency = Date.now() - startTime;

                removeElement(loadingId);

                // Use real reasoning steps from backend (Glass Box transparency)
                const reasoningSteps = (data.reasoning || []).map(step => ({
                    type: mapStepType(step.type),
                    label: step.label,
                    detail: step.detail,
                    durationMs: step.durationMs
                }));

                // Use sources from backend response
                const sources = (data.sources || []).map(s => ({ filename: s }));

                appendAssistantResponse(data.answer, reasoningSteps, sources, data.traceId);
                fetchTelemetry();

            } catch (error) {
                removeElement(loadingId);
                // Fallback to basic endpoint if enhanced fails
                try {
                    const fallbackResponse = await fetch(`${API_BASE}/ask?q=${encodeURIComponent(query)}&dept=${encodeURIComponent(sector)}`);
                    const answer = await fallbackResponse.text();
                    const reasoningSteps = generateReasoningSteps(query, answer);
                    const sourceMatches = answer.match(/\[([^\]]+\.(pdf|txt|md))\]/gi) || [];
                    const sources = sourceMatches.map(m => ({ filename: m.replace(/[\[\]]/g, '') }));
                    appendAssistantResponse(answer, reasoningSteps, sources);
                } catch (fallbackError) {
                    appendAssistantResponse(`Error: ${error.message}`, [], []);
                }
            }
        }

        // Map backend step types to frontend icon types
        function mapStepType(backendType) {
            const typeMap = {
                'security_check': 'search',
                'query_analysis': 'search',
                'query_decomposition': 'search',
                'vector_search': 'retrieve',
                'keyword_search': 'retrieve',
                'retrieval': 'retrieve',
                'reranking': 'retrieve',
                'filtering': 'retrieve',
                'context_assembly': 'synthesize',
                'llm_generation': 'synthesize',
                'response_generation': 'synthesize',
                'error': 'search'
            };
            return typeMap[backendType] || 'search';
        }

        function generateReasoningSteps(query, answer) {
            const steps = [];
            const hasResults = answer.includes('[') && (answer.includes('.pdf') || answer.includes('.txt') || answer.includes('.md'));

            steps.push({
                type: 'search',
                label: 'Query Analysis',
                detail: `Parsed query: "${query.substring(0, 50)}${query.length > 50 ? '...' : ''}"`
            });

            steps.push({
                type: 'search',
                label: 'Vector Search',
                detail: `Searching ${sectorSelect.value} sector with similarity threshold 0.7`
            });

            if (hasResults) {
                const matches = answer.match(/\[([^\]]+\.(pdf|txt|md))\]/gi) || [];
                steps.push({
                    type: 'retrieve',
                    label: 'Document Retrieval',
                    detail: `Found ${matches.length} relevant document(s) via HiFi-RAG`
                });

                steps.push({
                    type: 'synthesize',
                    label: 'Response Synthesis',
                    detail: 'Applied ANALYZE  VERIFY  CITE protocol'
                });
            } else {
                steps.push({
                    type: 'retrieve',
                    label: 'No Matches',
                    detail: 'No documents matched the similarity threshold'
                });
            }

            return steps;
        }

        // === SOURCE VIEWER ===
        async function openSource(filename) {
            // Add to tabs if not already there
            if (!state.openSources.includes(filename)) {
                state.openSources.push(filename);
            }
            state.activeSource = filename;

            renderSourceTabs();

            // Show viewer, hide empty state
            document.getElementById('source-empty').style.display = 'none';
            document.getElementById('source-viewer-container').style.display = 'flex';
            document.getElementById('source-viewer-container').style.flexDirection = 'column';
            document.getElementById('source-viewer-container').style.flex = '1';

            // Update meta
            document.getElementById('source-filename').textContent = filename;
            document.getElementById('source-sector').textContent = sectorSelect.value;
            document.getElementById('source-type').textContent = filename.endsWith('.pdf') ? 'PDF Document' : 'Text Document';

            // Fetch content
            const viewer = document.getElementById('source-viewer');
            viewer.textContent = 'Loading document content...';

            try {
                // Pass current query to get relevant highlights
                const currentQuery = queryInput.value.trim() || document.querySelector('.message.user:last-child .message-bubble')?.innerText || '';
                const res = await fetch(`${API_BASE}/inspect?fileName=${encodeURIComponent(filename)}&query=${encodeURIComponent(currentQuery)}`);

                // Handle JSON response
                const data = await res.json();

                // Format content with returned highlights
                viewer.innerHTML = formatSourceContent(data.content, data.highlights);

            } catch (error) {
                viewer.textContent = 'Error loading document: ' + error.message;
            }

            // Highlight active citation
            document.querySelectorAll('.citation').forEach(c => {
                c.classList.toggle('active', c.textContent.trim().includes(filename));
            });
        }

        function formatSourceContent(content, highlights = []) {
            // Normalize highlights for easier matching
            const normalizedHighlights = highlights.map(h => h.trim());

            const lines = content.split('\n');
            let inContent = false;
            let result = [];

            for (const line of lines) {
                if (line.startsWith('---')) {
                    inContent = true;
                    result.push(line);
                    continue;
                }

                if (inContent && line.trim()) {
                    // Check if this line is in the highlights list
                    const isHighlight = normalizedHighlights.some(h => line.includes(h) || h.includes(line.trim()));

                    if (isHighlight) {
                        result.push(`<div class="highlight">${escapeHtml(line)}</div>`);
                    } else {
                        result.push(escapeHtml(line));
                    }
                } else {
                    result.push(escapeHtml(line));
                }
            }

            return result.join('\n');
        }

        function renderSourceTabs() {
            const tabsContainer = document.getElementById('source-tabs');

            if (state.openSources.length === 0) {
                tabsContainer.style.display = 'none';
                return;
            }

            tabsContainer.style.display = 'flex';
            tabsContainer.innerHTML = '';

            state.openSources.forEach(filename => {
                const tab = document.createElement('div');
                tab.className = `source-tab ${filename === state.activeSource ? 'active' : ''}`;
                tab.innerHTML = `
                <span onclick="openSource('${escapeHtml(filename)}')">${filename}</span>
                <span class="close" onclick="event.stopPropagation(); closeSource('${escapeHtml(filename)}')"></span>
            `;
                tabsContainer.appendChild(tab);
            });
        }

        function closeSource(filename) {
            state.openSources = state.openSources.filter(f => f !== filename);

            if (state.activeSource === filename) {
                state.activeSource = state.openSources[0] || null;
                if (state.activeSource) {
                    openSource(state.activeSource);
                } else {
                    document.getElementById('source-empty').style.display = 'flex';
                    document.getElementById('source-viewer-container').style.display = 'none';
                }
            }

            renderSourceTabs();
        }

        function closeAllSources() {
            state.openSources = [];
            state.activeSource = null;
            document.getElementById('source-tabs').style.display = 'none';
            document.getElementById('source-empty').style.display = 'flex';
            document.getElementById('source-viewer-container').style.display = 'none';
        }

        // === FEEDBACK ===
        function handleFeedback(msgId, type) {
            if (type === 'positive') {
                // Mark as helpful
                const btn = document.querySelector(`#${msgId} .feedback-btn.positive`);
                btn.classList.add('active');
                // Feedback recorded locally (backend integration available)
            } else {
                // Open feedback modal
                state.currentFeedbackMsgId = msgId;
                document.getElementById('feedback-modal').classList.add('open');
            }
        }

        function closeFeedbackModal() {
            document.getElementById('feedback-modal').classList.remove('open');
            state.currentFeedbackMsgId = null;

            // Reset selection
            document.querySelectorAll('.feedback-option').forEach(opt => {
                opt.classList.remove('selected');
            });
        }

        // Initialize feedback option clicks
        document.querySelectorAll('.feedback-option').forEach(opt => {
            opt.addEventListener('click', () => {
                document.querySelectorAll('.feedback-option').forEach(o => o.classList.remove('selected'));
                opt.classList.add('selected');
            });
        });

        function submitFeedback() {
            const selected = document.querySelector('.feedback-option.selected');
            if (!selected) {
                alert('Please select a feedback category');
                return;
            }

            const feedbackType = selected.dataset.value;
            // Feedback recorded locally (backend integration available)

            // Mark the button as active
            if (state.currentFeedbackMsgId) {
                const btn = document.querySelector(`#${state.currentFeedbackMsgId} .feedback-btn.negative`);
                if (btn) btn.classList.add('active');
            }

            closeFeedbackModal();
        }

        // === UTILITIES ===
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getTimestamp() {
            return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }
    </script>
</body>

</html>